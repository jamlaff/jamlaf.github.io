## Command Injection 공격 (명령어 주입 공격)

### 개요
- 이번 2주차 Writeup 에서는 Command Injection 공격(명령어 주입 공격)에 대한 공부 및 실습을 진행해보았다.
- 아래 설명하는 모든 공부 및 실습은 VirtualBox - Kali Linux 가상머신에서 DVWA 취약한 웹 환경을 구성하여 이루어졌다.

### 목차
이번 Writeup 에서 진행하는 Command Injection과 관련된 공부는 다음과 같다.
1. 취약점 정보/설명 - Command Inejction 공격에 대한 연구
2. 개념 증명 실습 - DVWA Security Level(Low, Midium, High)로 구성된 실습 진행
3. 대응방안 공부 - Command Injection 공격에 대한 대응 방안
4. 레퍼런스

### 취약점 정보
- Command Injection 취약점은 

![이미지](/assets/OWASP_injection.png)

2022년 부터 2023년 현재까지 OWASP(Open Web Application Security Project) 상위 10개 취약점에서는 Injection 공격이 3위를 이루고 있는 것을 확인할 수 있다. 취약점에 노출되어 주입 공격에 성공할 경우 악의적인 시스템 명령어를 통해 데이터 손실, 도난, 노출 등을 유발하며 최악의 경우 전체 시스템을 장악하고 손상시킬 수 있는 공격으로 심각한 피해를 입을 수 있는 공격이니 Injection에 대한 철저한 보안 설정 및 시큐어 코딩이 필요하다.

### 취약점 설명
Command Injection 이란?
명령어를 주입한다 라는 뜻으로, 취약한 애플리케이션을 통해 호스트 OS에서 시스템 명령을 실행하는 것을 목표로 하며 웹 요청 메시지에 임의의 시스템 명령어를 삽입하고 전송하면 웹 서버에서 해당 명령어를 살행하도록 하는 공격을 의미한다. 공격자가 사용하는 운영체제 명령은 일반적으로 취약한 응용 프로그램의 권한으로 실행된다.

##### Command Injection에 취약한 함수
OS에서 시스템 명령을 실행하여 데이터를 노출, 손실 및 도난이 가능하다 하였는데 해당 시스템 명령을 통해  Command Injection 공격에 취약한 함수와 메타문자 등이 존재한다.

언어
Java - Ststen.*, System.runtime, Runtime.exec()
C/C++ - system(). exec(), ShellExecute()
python - exec(), eval(), os.system(), os.popen(), subprocess.popen(), subprocess.call()
Perl - open(). sysopen(), system(), glob()
php - exec(), system(), passthru(), popen(), rquire(), include(), eval(), preg_replace(), shell_exec(), proc_open(), eval()

#### 메타문자
쉘에는 한 줄에 여러 명령어를 실행하는 등의 쉘 사용자 편의성을 위해 제공하는 특수 문자들이 존재한다. 시스템 명령이 수행된다면 특수문자를 활용해 Command Injection 공격이 가능하다.

메타문자 - 뜻
'' - 명령어 치환 : ''안에 들어있는 명령어를 실행한 결과로 치환
$() - 명령어 치환 : $() 안에 들어있는 명령어를 실행한 결과로 치환, 중복 사용 가능
&& - 명령어 연속실행 : 한 줄에 여러 명령어를 사용하고 싶을 때 사용. 앞 명령어에서 에러가 발생하지 않아야 뒷 명령어 실행
|| - 명령어 연속 실행 : 한 줄에 여러 명령어를 사용하고 싶을 때 사용. 앞 명령어에서 에러가 발생해야 뒷 명령어 실행
; - 명령어 구분자 한 줄에 여러 명령어를 사용하고 싶을 때 사용. ; 은 단순히 명령어 구분을 위해 사용하며, 앞 명령어의 에러 유무와 관계 없이 뒷 명령어 실행
| - 파이프 앞 명령어 결과가 뒷 명령어 입력으로 들어간다.
그 외 - ., >, >>, &>, >&, <, {}, ?, *, ~


### 개념 증명
DVWA 취약 환경에서 Command Injection 공격을 실습해보았습니다. 다음과 같은 페이지에서 입력창에 IP를 넣으면 해당 IP주소로 ping 명령어를 실행한 후 그 결과를 출력해 주는 페이지이다.

* Low Level
![이미지](/assets/7_ping.png)

IP(127.0.0.1) 입력해 보았을 때 ping 127.0.0.1 결과를 출력해주는 것을 볼 수 있었다.

![이미지](/assets/1_id.png)

IP 뒤에 '&& id' 명령을 입력하였더니 ping 명령어 진행 후 id 명령을 통해 현재 공격 대상자의 사용자 정보를 출력하는 것을 확인하였다.

* 만약 대상 시스템이 root 사용자 권한으로 실행되고 있는 경우 공격자는 root 권한을 쉽게 획득 할 수 있으며, root권한이 아니더라도 일반 사용자 권한에서 '권한 상승 공격' 을 시도가 가능하게 된다. 그렇게 되면 시스템을 장악할 수 있는 권한이 공격자에게 넘어가버려 큰 위험에 노출될 것이다.

![이미지](/assets/cat_etc.png)

IP를 생략하고 ';' 뒤에 'cat /etc/passwd' 명령을 통해 원격 호스트 대상으로 시스템 명령어를 자유롭게 사용 가능한 것을 확인할 수 있었다. 

- 리눅스 환경에서 '/etc/passwd' 파일은 시스템에 등록된 사용자 정보들이 담겨있는 파일로, 관리자는 해당 파일을 이용하여 사용자의 계정과 인증을 관리한다. 만약 시스템에 평문의 비밀번호를 가지고 있는 파일이 저장되어 있다면, 모든 사용자의 비밀번호가 노출될 수 있는 위험도 피할 수 없다.

* 소스코드 확인(Low)

사용자가 입력하는 인자값을 조작하여 OS 명령을 실행함으로써, 공격자가 원하는 정보를 획득할 수 있는 것을 확인하였다. Command Injection 취약점에 노출된 웹 환경의 소스코드를 확인해보았다.

![이미지](/assets/low_sourcecode.png)

소스 코드를 확인 해보니 ping 명령을 전달할 때 'ping -c 4'를 통해 ping을 보내게 된다. -c 옵션은 4번의 ICMP request와 reponse로 ping 명령을 종료하겠다 라는 의미이다. 

뒤에 '$target'은 웹의 요청 메시지로 부터 전달된 파라미터 값으로 '$target' 부분에 IP를 전달받아 ping 명령이 실행되게 된다.

따라서 IP값을 전달하여 ping 명령을 실행할 때 뒤에 메타문자(;,&&,| 등)을 사용하여 다른 명령어가 실행되도록 전달인자 값을 보내어 시스템의 정보 노출 및 권한 획득 공격까지 수행할 수 있다.

* Midium Level

* High Level


### 취약점 원인

ping 명령은 shell을 통해 실행이 되는데 웹에서 시스템 명령이 실행되는 것은 운영체제에게 시스템 명령을 호출하는 것으로, Command Injection에 취약점이 있는 웹 환경을 확인하였다. 어째서 이게 가능한 것일까?


### 대응 방안

# 툴 제작 ?

# 레퍼런스
